<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Chat Demo v·ªõi SignalR & Firebase</title>
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .chat-container {
            display: flex;
            gap: 20px;
            height: 600px;
        }
        
        .connection-panel {
            width: 300px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .chat-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 15px 20px;
            background: #007bff;
            color: white;
            border-radius: 8px 8px 0 0;
        }
        
        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #fafafa;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 70%;
        }
        
        .message.sent {
            background: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .message.received {
            background: white;
            border: 1px solid #ddd;
        }
        
        .message-info {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .typing-indicator {
            padding: 10px;
            font-style: italic;
            color: #666;
            display: none;
        }
        
        .input-panel {
            padding: 20px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }
        
        input, button, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            min-width: 100px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.error {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        #messageInput {
            flex: 1;
        }
        
        .online-users {
            margin-top: 20px;
        }
          .user-list {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .test-functions {
            margin-top: 20px;
        }
        
        .test-functions button {
            font-size: 12px;
            padding: 8px;
        }
        
        .message.system {
            background: #e9ecef;
            border: 1px solid #dee2e6;
            color: #495057;
        }
    </style>
</head>
<body>
    <h1>üöÄ Real-time Chat Demo v·ªõi SignalR & Firebase</h1>
    
    <div class="chat-container">
        <!-- Panel k·∫øt n·ªëi -->
        <div class="connection-panel">
            <h3>K·∫øt n·ªëi & C√†i ƒë·∫∑t</h3>
            
            <div class="form-group">
                <label for="serverUrl">Server URL:</label>
                <input type="text" id="serverUrl" value="https://localhost:7092/chathub" style="width: 100%;">
            </div>
            
            <div class="form-group">
                <label for="userId">User ID:</label>
                <input type="number" id="userId" value="1" style="width: 100%;">
            </div>
            
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" value="User1" style="width: 100%;">
            </div>
            
            <div class="form-group">
                <label for="chatroomId">Chatroom ID:</label>
                <input type="number" id="chatroomId" value="1" style="width: 100%;">
            </div>
            
            <button id="connectBtn" onclick="connect()">K·∫øt n·ªëi</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>Ng·∫Øt k·∫øt n·ªëi</button>
            
            <div id="connectionStatus" class="status disconnected">
                Ch∆∞a k·∫øt n·ªëi
            </div>
            
            <div class="form-group">
                <button onclick="joinRoom()" disabled id="joinRoomBtn">Tham gia ph√≤ng</button>
                <button onclick="leaveRoom()" disabled id="leaveRoomBtn">R·ªùi ph√≤ng</button>
            </div>
              <div class="online-users">
                <h4>Users Online:</h4>
                <div id="onlineUsersList" class="user-list">
                    Ch∆∞a c√≥ ai online
                </div>
            </div>

            <div class="test-functions">
                <h4>Test Functions:</h4>
                <button onclick="testPing()" style="width: 100%; margin-bottom: 5px;">Ping Server</button>
                <button onclick="testTypingMethod()" style="width: 100%; margin-bottom: 5px;">Test Typing Method</button>
                <button onclick="testSendTyping()" style="width: 100%; margin-bottom: 5px;">Test SendTyping</button>
                <button onclick="markMessageAsRead()" style="width: 100%; margin-bottom: 5px;">Mark Last Message Read</button>
                <button onclick="getOnlineUsers()" style="width: 100%;">Get Online Users</button>
            </div>
        </div>
        
        <!-- Panel chat -->
        <div class="chat-panel">
            <div class="chat-header">
                <h3 id="chatTitle">Chat Room #1</h3>
                <div id="chatStatus">Ch∆∞a tham gia ph√≤ng chat</div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <div class="message received">
                    <div><strong>System:</strong> Ch√†o m·ª´ng ƒë·∫øn v·ªõi demo chat!</div>
                    <div class="message-info">H∆∞·ªõng d·∫´n: K·∫øt n·ªëi server ‚Üí Tham gia ph√≤ng ‚Üí B·∫Øt ƒë·∫ßu chat</div>
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <span id="typingText"></span>
            </div>
            
            <div class="input-panel">
                <input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." disabled>
                <button onclick="sendMessage()" disabled id="sendBtn">G·ª≠i</button>
            </div>
        </div>
    </div>

    <script>
        let connection = null;
        let currentUserId;
        let currentChatroomId = null;
        let isTyping = false;
        let typingTimeout = null;

        // Kh·ªüi t·∫°o k·∫øt n·ªëi SignalR
        async function connect() {
            const serverUrl = document.getElementById('serverUrl').value;
            const userId = document.getElementById('userId').value;
            const username = document.getElementById('username').value;
            
            if (!serverUrl || !userId) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin k·∫øt n·ªëi!');
                return;
            }

            try {
                // T·∫°o connection
                connection = new signalR.HubConnectionBuilder()
                    .withUrl(serverUrl)
                    .withAutomaticReconnect()
                    .build();

                // ƒêƒÉng k√Ω c√°c event handlers
                setupEventHandlers();

                // K·∫øt n·ªëi
                await connection.start();
                
                // ƒêƒÉng k√Ω user
                await connection.invoke("RegisterUser", userId);
                
                currentUserId = userId;
                updateConnectionStatus(true);
                
                console.log('K·∫øt n·ªëi SignalR th√†nh c√¥ng!');
                
            } catch (err) {
                console.error('L·ªói k·∫øt n·ªëi:', err);
                updateConnectionStatus(false, err.message);
            }
        }

        // Ng·∫Øt k·∫øt n·ªëi
        async function disconnect() {
            if (connection) {
                await connection.stop();
                connection = null;
                currentUserId = null;
                updateConnectionStatus(false);
                console.log('ƒê√£ ng·∫Øt k·∫øt n·ªëi');
            }
        }

        // Tham gia ph√≤ng chat
        async function joinRoom() {
            if (!connection) {
                alert('Ch∆∞a k·∫øt n·ªëi t·ªõi server!');
                return;
            }
            
            const chatroomId = document.getElementById('chatroomId').value;
            const userId = document.getElementById('userId').value;
            
            if (!chatroomId) {
                alert('Vui l√≤ng nh·∫≠p Chatroom ID!');
                return;
            }

            try {
                await connection.invoke("JoinChatroom", chatroomId, userId);
                currentChatroomId = chatroomId;
                document.getElementById('chatTitle').textContent = `Chat Room #${chatroomId}`;
                document.getElementById('chatStatus').textContent = `ƒê√£ tham gia ph√≤ng #${chatroomId}`;
                
                // Enable message input
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('leaveRoomBtn').disabled = false;
                document.getElementById('joinRoomBtn').disabled = true;
                
            } catch (err) {
                console.error('L·ªói tham gia ph√≤ng:', err);
                addMessage('System', 'L·ªói tham gia ph√≤ng: ' + err.message, 'error');
            }
        }

        // R·ªùi ph√≤ng chat
        async function leaveRoom() {
            if (!connection || !currentChatroomId) return;

            try {
                await connection.invoke("LeaveChatroom", currentChatroomId, currentUserId);
                currentChatroomId = null;
                
                document.getElementById('chatStatus').textContent = 'ƒê√£ r·ªùi ph√≤ng chat';
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
                document.getElementById('leaveRoomBtn').disabled = true;
                document.getElementById('joinRoomBtn').disabled = false;
                
            } catch (err) {
                console.error('L·ªói r·ªùi ph√≤ng:', err);
            }
        }

        // G·ª≠i tin nh·∫Øn
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !connection || !currentChatroomId) return;

            try {
                await connection.invoke("SendMessage", 
                    parseInt(currentUserId), 
                    parseInt(currentChatroomId), 
                    message
                );

                // await connection.invoke("SendTyping", parseInt(currentUserId), parseInt(currentChatroomId), document.getElementById('username').value);
                // addMessage(document.getElementById('username').value, message, 'sent');
                console.log('Tin nh·∫Øn ƒë√£ g·ª≠i:', message);
                
                messageInput.value = '';
                
            } catch (err) {
                console.error('L·ªói g·ª≠i tin nh·∫Øn:', err);
                addMessage('System', 'L·ªói g·ª≠i tin nh·∫Øn: ' + err.message, 'error');
            }
        }        
        
        // X·ª≠ l√Ω typing
        function handleTyping() {
            console.log('handleTyping called, isTyping:', isTyping, 'connection:', !!connection, 'currentChatroomId:', currentChatroomId);
            
            if (!isTyping && connection && currentChatroomId) {
                isTyping = true;
                const username = document.getElementById('username').value;
                console.log('Sending typing indicator for user:', username, 'userId:', currentUserId, 'chatroomId:', currentChatroomId);
                
                connection.invoke("SendTyping", parseInt(currentUserId), parseInt(currentChatroomId), username)
                    .then(() => {
                        console.log('SendTyping successfully invoked');
                    })
                    .catch(err => {
                        console.error('Error sending typing indicator:', err);
                        addMessage('System', 'Error sending typing: ' + err.message, 'error');
                    });
            }
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(stopTyping, 2000);
        }

        function stopTyping() {
            console.log('stopTyping called, isTyping:', isTyping, 'connection:', !!connection, 'currentChatroomId:', currentChatroomId);
            
            if (isTyping && connection && currentChatroomId) {
                isTyping = false;
                console.log('Sending stop typing indicator for userId:', currentUserId, 'chatroomId:', currentChatroomId);
                
                connection.invoke("StopTyping", parseInt(currentUserId), parseInt(currentChatroomId))
                    .then(() => {
                        console.log('StopTyping successfully invoked');
                    })
                    .catch(err => {
                        console.error('Error sending stop typing indicator:', err);
                        addMessage('System', 'Error stopping typing: ' + err.message, 'error');
                    });
            }
        }

        // Setup event handlers cho SignalR
        function setupEventHandlers() {            
            
            // Nh·∫≠n tin nh·∫Øn
            connection.on("ReceiveMessage", function (messageData) {
                const isOwn = messageData.senderId == currentUserId;
                addMessage(
                    messageData.senderName, 
                    messageData.content, 
                    isOwn ? 'sent' : 'received',
                    messageData.CreatedAt
                );
                
                // L∆∞u ID tin nh·∫Øn cu·ªëi c√πng ƒë·ªÉ test mark as read
                lastMessageId = messageData.MessageId;
            });

            connection.on("ReceiveChatroomUsers", function (users) {
                const userList = document.getElementById('onlineUsersList');
                userList.innerHTML = ''; // Clear current list
                
                if (users.length === 0) {
                    userList.textContent = 'Ch∆∞a c√≥ ai online';
                    return;
                }
                
                users.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.textContent = `${user.UserId} - ${user.Username}`;
                    userList.appendChild(userItem);
                });
            });

            connection.on("ReceiveNotification", function (notification) {
                // addMessage('System', notification.Message, 'system');
            });

            // Th√¥ng b√°o k·∫øt n·ªëi th√†nh c√¥ng
            connection.on("Connected", function (data) {
                addMessage('System', `K·∫øt n·ªëi th√†nh c√¥ng! Connection ID: ${data.Message}`, 'system');
            });

            // X√°c nh·∫≠n tham gia ph√≤ng
            connection.on("JoinConfirmation", function (data) {
                // addMessage('System', data.Message, 'system');
            });            
            
            // X√°c nh·∫≠n r·ªùi ph√≤ng
            connection.on("LeaveConfirmation", function (data) {
                // addMessage('System', data.Message, 'system');
            });

            // User tham gia ph√≤ng
            connection.on("UserJoinedChatroom", function (data) {
                addMessage('System', `${data.userId} ƒë√£ tham gia ph√≤ng chat`, 'system');
            });

            // User r·ªùi ph√≤ng
            connection.on("UserLeftChatroom", function (data) {
                addMessage('System', `${data.Username} ƒë√£ r·ªùi ph√≤ng chat`, 'system');
            });            
            // Typing indicators
            connection.on("UserTyping", function (data) {
                showTypingIndicator(`${data.senderName} ƒëang nh·∫≠p...`);
            });

            connection.on("UserStoppedTyping", function (data) {
                hideTypingIndicator();
            });

            // Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c ch·ªânh s·ª≠a
            connection.on("MessageEdited", function (data) {
                addMessage('System', `Tin nh·∫Øn #${data.MessageId} ƒë√£ ƒë∆∞·ª£c ch·ªânh s·ª≠a`, 'system');
            });

            // Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c x√≥a
            connection.on("MessageDeleted", function (data) {
                addMessage('System', `Tin nh·∫Øn #${data.MessageId} ƒë√£ ƒë∆∞·ª£c x√≥a`, 'system');
            });

            // L·ªói
            connection.on("ReceiveError", function (error) {
                addMessage('System', `L·ªói: ${error.Message || error}`, 'error');
            });

            // User online/offline
            connection.on("UserOnline", function (userId) {
                console.log(`User ${userId} ƒë√£ online`);
            });

            connection.on("UserOffline", function (userId) {
                console.log(`User ${userId} ƒë√£ offline`);
            });            

            // Message read receipts
            connection.on("MessageRead", function (data) {
                console.log(`Tin nh·∫Øn #${data.MessageId} ƒë√£ ƒë∆∞·ª£c ƒë·ªçc b·ªüi User ${data.ReadBy}`);
            });

            // Broadcast notifications
            connection.on("BroadcastNotification", function (data) {
                addMessage('üì¢ Th√¥ng b√°o', data.Body, 'system');
            });            // Ping/Pong for connection health
            connection.on("Pong", function (timestamp) {
                console.log('Pong received at:', timestamp);
                addMessage('System', `Pong received at ${new Date(timestamp).toLocaleTimeString()}`, 'system');
            });

            // Online users in chatroom response
            connection.on("OnlineUsersInChatroom", function (data) {
                const userList = document.getElementById('onlineUsersList');
                userList.innerHTML = '';
                
                if (data.OnlineUsers.length === 0) {
                    userList.textContent = 'Ch∆∞a c√≥ ai online';
                } else {
                    data.OnlineUsers.forEach(user => {
                        const userItem = document.createElement('div');
                        userItem.textContent = `${user.UserId} - ${user.Username}`;
                        userList.appendChild(userItem);
                    });
                }
                
                addMessage('System', `${data.Count} users online in chatroom`, 'system');
            });
        }

        // Utility functions
        function updateConnectionStatus(connected, error = null) {
            const statusEl = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const joinRoomBtn = document.getElementById('joinRoomBtn');
            
            if (connected) {
                statusEl.textContent = `ƒê√£ k·∫øt n·ªëi (User ID: ${currentUserId})`;
                statusEl.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                joinRoomBtn.disabled = false;
            } else {
                statusEl.textContent = error ? `L·ªói k·∫øt n·ªëi: ${error}` : 'Ch∆∞a k·∫øt n·ªëi';
                statusEl.className = error ? 'status error' : 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                joinRoomBtn.disabled = true;
                document.getElementById('leaveRoomBtn').disabled = true;
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
            }
        }

        function addMessage(sender, message, type = 'received', timestamp = null) {
            const container = document.getElementById('messagesContainer');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            
            const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
            
            messageEl.innerHTML = `
                <div><strong>${sender}:</strong> ${message}</div>
                <div class="message-info">${time}</div>
            `;
            
            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
        }

        function showTypingIndicator(text) {
            const indicator = document.getElementById('typingIndicator');
            const textEl = document.getElementById('typingText');
            textEl.textContent = text;
            indicator.style.display = 'block';
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }        
        
        // Event listeners
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            } else {
                handleTyping();
            }
        });
        
        // Th√™m event listener cho input ƒë·ªÉ b·∫Øt typing
        document.getElementById('messageInput').addEventListener('input', function(e) {
            handleTyping();
        });

        // Test functions
        async function testPing() {
            if (connection) {
                try {
                    await connection.invoke("Ping");
                    addMessage('System', 'Ping sent to server', 'system');
                } catch (err) {
                    addMessage('System', 'Ping failed: ' + err.message, 'error');
                }
            }
        }

        let lastMessageId = null;
        async function markMessageAsRead() {
            if (connection && currentChatroomId && lastMessageId) {
                try {
                    await connection.invoke("MarkMessageAsRead", lastMessageId, parseInt(currentUserId), parseInt(currentChatroomId));
                    addMessage('System', `Marked message #${lastMessageId} as read`, 'system');
                } catch (err) {
                    addMessage('System', 'Mark as read failed: ' + err.message, 'error');
                }
            } else {
                addMessage('System', 'No message to mark as read', 'system');
            }
        }

        async function getOnlineUsers() {
            if (connection && currentChatroomId) {
                try {
                    await connection.invoke("GetOnlineUsersInChatroom", currentChatroomId);
                    addMessage('System', 'Requested online users list', 'system');
                } catch (err) {
                    addMessage('System', 'Get online users failed: ' + err.message, 'error');
                }
            }
        }

        // Test functions cho typing
        async function testTypingMethod() {
            if (connection) {
                try {
                    await connection.invoke("TestTyping");
                    addMessage('System', 'TestTyping method called', 'system');
                } catch (err) {
                    addMessage('System', 'TestTyping failed: ' + err.message, 'error');
                }
            } else {
                addMessage('System', 'Not connected', 'error');
            }
        }

        async function testSendTyping() {
            if (connection && currentChatroomId) {
                try {
                    const username = document.getElementById('username').value;
                    console.log('Testing SendTyping with params:', parseInt(currentUserId), parseInt(currentChatroomId), username);
                    
                    await connection.invoke("SendTyping", parseInt(currentUserId), parseInt(currentChatroomId), username);
                    addMessage('System', 'SendTyping test called successfully', 'system');
                } catch (err) {
                    console.error('SendTyping test error:', err);
                    addMessage('System', 'SendTyping test failed: ' + err.message, 'error');
                }
            } else {
                addMessage('System', 'Not connected or not in chatroom', 'error');
            }
        }
        
        // T·ª± ƒë·ªông k·∫øt n·ªëi khi trang load (ƒë·ªÉ demo)
        window.addEventListener('load', function() {
            // Uncomment d√≤ng d∆∞·ªõi ƒë·ªÉ t·ª± ƒë·ªông k·∫øt n·ªëi
            // setTimeout(connect, 1000);
        });
    </script>
</body>
</html>
